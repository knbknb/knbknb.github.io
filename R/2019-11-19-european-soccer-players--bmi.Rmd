---
title: "European Soccer Players and their BMI"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: 
  html_document: 
    keep_md: yes
categories: R fun
summary: Players in European soccer leagues have a BMI that is normally distributed with a mean of 23 and an sd of 1.3. This is independent of body size.
knit: (function(inputFile, encoding) { 
      rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_file=file.path(dirname(inputFile), 'out_dir', '2017-11-19-european-soccer-players-and-their-bmi.html')) })

---

```{r setup, include=FALSE}
# 2017-11-19 
knitr::opts_chunk$set(echo = TRUE)
```
## Playing with a Soccer Database 

Recently I've downloaded as a [zipfile (36 MB)](https://www.kaggle.com/hugomathien/soccer/downloads/soccer.zip) from data science community [Kaggle.com](https://www.kaggle.com/hugomathien/soccer).


This zipfile contains a single file, a 313 MB sqlite Database. Let's see exactly what's inside:

Create connection to football DB

```{r DBI, message=FALSE, warning=FALSE}

library(DBI)
con <- dbConnect(odbc::odbc(), "well-sqlite-footballdb")

```

Read in R packages  necessary to load the data: 
```{r message=FALSE, warning=FALSE, results='hide'}
# tidyverse packages
library(dplyr, warn.conflicts = FALSE) # 
library(purrr)   # functional programming
library(stringr)
library(lubridate) # strings to datetime
library(ggplot2)

theme_set(theme_bw())

```

The database consists of 7 tables. We'll read in all of them although we need only one, the Player table, which contains basic data of ~10000 soccer players from the top leagues of 14 European countries. They are not strictly "European soccer players", but players from all over the globe, competing in the European Leagues.

```{r}
table_names <- dbListTables(con)

good <- !  str_detect(table_names, "sqlite_sequence")
table_names <- table_names[good]

# Import all tables as data frames, 308MB
# feasible with lots of RAM
walk(table_names,function(x) assign(x, dbReadTable(x, conn=con),envir = globalenv()))
dbDisconnect(con)


```

The `Player` table lists the soccer players' weights in pounds, and their height in Centimeters. I don't know how the people who compiled the database obtained the weight data, but I think FIFA requires it for their records.
We'll calculate [Body Mass Index](https://en.wikipedia.org/wiki/Body_mass_index), (bmi) for each player which is defined as

```{r results='hide', echo=FALSE}
# if need be, read in single table - again
#Player <- con %>%  DBI::dbReadTable("Player")
#Match  <-  con %>%  DBI::dbReadTable("Match")

```

$$\mbox{Body Mass Index }{bmi}=\frac{height}{weight^2}$$
and has `kg/m^2` as the units of measure, but we'll omit this from now on.

We'll also create three size classes, large players who are taller than 1.90 m, 'medium' size players who are between 1.75 and 1.90 m tall, and 'small' players who are less than 1.75m.

```{r player, results='hide'}
pounds_per_kg <- 0.453592

sizes <- c("large" = 190, "small" = 175)
Player %<>%
  mutate(birthday = ymd(as_datetime(birthday))) %>% # convert string to datetime column
  mutate(weight = weight * pounds_per_kg) %>%
  mutate(bmi = weight /((height/100)^2)) %>%
  mutate(size = factor(if_else(height >= sizes["large"], "large", 
                               if_else(height >= sizes["small"], "medium", "small"))))
  
```

Who are the largest players with the highest BMI?

```{r}
players_large <- Player %>%
  filter(size == "large") %>%
  arrange(desc(bmi))


(players_large_top <- players_large %>% select(player_name, birthday, height, weight, bmi) %>% head())

```

Here I look up some more info about these high-BMI players. I'll use my own magic function `kgapi_lookup_kv()` that looks up terms in the Google Knowledge graph API. 

```{r results='hide'}
players_large_top_kg <- map(players_large_top$player_name, kgapi_lookup_kv)
```

Processing the column names is a bit messy, so this will not be shown here.

```{r results='hide', echo=FALSE, comment="intermediate, messy calculations"}

w <- players_large_top_kg %>%  
  map_df(tidyr::spread, key="key", value="value")  
w["result..type"] <- NULL
w["result.url"] <- NULL
w <- map_df(w, unlist)
colnames(w) <- str_replace(colnames(w), "result\\.+", "")
colnames(w) <- str_replace(colnames(w), "detailedDescription\\.+", "")
players_large_top_detail <- w %>% 
  select(name, description, long_description=articleBody, url=image.url) %>%    mutate(long_description=str_replace_all(long_description, "\\.\\s.*", ".")) %>%
  semi_join(players_large_top, by=c("name" = "player_name"))

#players_large_top_detail

```

End result:

```{r echo=FALSE}
knitr::kable(players_large_top_detail, )
```


```{r echo=FALSE, results='hide'}
wiese_bmi <- players_large %>% filter(player_name == "Tim Wiese") %>%  select(bmi)
```

Surprisingly, German goalie [Tim Wiese](https://en.wikipedia.org/wiki/Tim_Wiese) has the highest BMI. His career in the Bundesliga has ended, but he made some headlines in 2014-2016 because did bodybuilding, an tried -temporarily- to pursue a career in Wrestling.

His BMI is `r sprintf("%.1f", wiese_bmi)` kg/m². How large an outlier is this? Let's plot some histograms:

```{r}
# calculate a few values to make plots more informative
range_bmi <- Player %>%  select(bmi) %>% range()
med_bmi <- median(Player$bmi)

diff_bmi  <- range_bmi %>% diff() %>% ceiling()
rng_seas  <- range(Match$season)
np        <- nrow(Player)

# common to all plots
decorate <- function(x) {
  list(
    ggtitle("Body Mass Index of Soccer Players",
                      subtitle =  sprintf("%s Players from Europe's Top Leagues, 2008-2016",x)) ,
    xlab("Player Body Mass Index") ,
    theme(legend.justification=c(1.25,0.95), legend.position=c(1,0.95)) ,
    scale_fill_discrete(name = "Player Height", labels=c(sprintf("> %s cm)",sizes["large"]),
                                                         sprintf(">= %s cm)",sizes["small"]),
                                                         sprintf("< %s cm)",sizes["small"])))
  )

}

```

Display raw histogram with absolute counts:

```{r}

Player %>%
  ggplot(aes(bmi, fill=size)) + geom_histogram(alpha=0.5, bins = diff_bmi*2) +
  decorate(np) +
  geom_vline(xintercept=med_bmi, size=0.3, color="darkgrey") +
  annotate(geom = "text", x = 20, y = 1690, label = sprintf("median BMI: %.1f ->", med_bmi), color="darkgrey") +
  geom_vline(xintercept=25.5, size=0.3, color="darkgrey") +
  annotate(geom = "text", x = 27.5, y = 750, label = sprintf("<- BMI %.1f:\n \"overweight\"", 25.5), color="darkgrey")

```

```{r results='hide'}
Player %>%
  ggplot(aes(bmi, fill=size)) +
  geom_histogram(aes(y = ..density..), alpha=0.5, bins = diff_bmi *3) +
  decorate(np)

```



```{r}


dnorm_fit <- MASS::fitdistr(Player$bmi, densfun = "normal")

Player %>%
  ggplot(aes(bmi, fill = size)) +
  geom_density(alpha = 0.5) +
  stat_function(
    fun = function(x) dnorm(x, dnorm_fit$estimate["mean"], dnorm_fit$estimate["sd"]),
    color = "red",
    size = 0.5
  ) +
  ggtitle(
    "Body Mass Index of Soccer Players",
    subtitle = sprintf(
      "%s Players from Europe's Top Leagues, 2008-2016. Mean BMI = %.1f kg/m², std.dev = %.1f",
      np, dnorm_fit$estimate["mean"], dnorm_fit$estimate["sd"]
    )
  ) +
  xlab("Player Body Mass Index") +
  # geom_vline(xintercept=dnorm_fit$estimate["mean"], color="red", size=0.2) +
  facet_wrap(~ size) +
  theme(legend.position = "none")

```
So we see that the BMI of soccer players in the top European League fits pretty well a normal distribution with parameters mean = `r ` the 
